<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<base target="_blank" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<script type="text/javascript">
var userAgent = navigator.userAgent.toLowerCase();
var browser = 
	(browser = userAgent.match(/qqbrowser\/([\d.]+)/))?"qqbrowser/"+browser[1]:
	(browser = userAgent.match(/se\s+2.x/))?"sogou/2.x": //65.29%
	(browser = userAgent.match(/msie\s+([\d.]+)/))?"msie/"+browser[1]: //ie
	(browser = userAgent.match(/chrome\/([\d.]+)/))?"chrome/"+browser[1]: //chrome
	(browser = userAgent.match(/firefox\/([\d.]+)/))?"firefox/"+browser[1]: //firefox
	(browser = userAgent.match(/version\/([\d.]+)\s+safari\/([\d.]+)/))?"safari/"+browser[1]: //safari
	(browser = userAgent.match(/opera\/([\d.]+)([\w\W]+)version\/([\d.]+)/))?"opera/"+browser[3]: //opera
	"other browser";
	var browser4 = browser.substr(0,2);
//实现回到页面顶部  
function goTopEx(){  
	var obj=document.getElementById("goTopBtn"); 
	var obj2=document.getElementById("shangy"); 
	var obj3=document.getElementById("xiay");
	var obj4=document.getElementById("goBottom");  
	
	function getScrollTop(){  
		if(browser4=="ch"){
			//谷歌浏览器  
			return document.documentElement.scrollTop; 
		}else{
			//IE、firefox等浏览器 
			return document.documentElement.scrollTop;  
		}  
	}
	function setScrollTop(value){ 
		if(browser4=="ch"){ 
			//谷歌浏览器  
			document.documentElement.scrollTop=value; 
		}else{  
			//IE、firefox等浏览器
			document.documentElement.scrollTop=value;  
		} 
	}     
	window.onscroll=function(){getScrollTop()>50?obj.style.display="":obj.style.display="none";
	getScrollTop()>100?obj2.style.display="":obj2.style.display="none";
	document.body.clientHeight-getScrollTop()>650?obj3.style.display="":obj3.style.display="none";
	document.body.clientHeight-getScrollTop()>650?obj4.style.display="":obj4.style.display="none";
	}  
	obj.onclick=function(){  
		var goTop=setInterval(scrollMove,10);  
		function scrollMove(){  
				setScrollTop(getScrollTop()/1.1);  
				if(getScrollTop()<1)clearInterval(goTop);  
		}  
	}  
}  
function downn(){
	if(browser4=="ch"){
		//谷歌浏览器  
		window.scrollBy(0,document.body.clientHeight);
	}else{
		//IE、firefox等浏览器  
		window.scrollBy(0,document.documentElement.clientHeight*1000); 
	}
}
</script>
<script>
document.write('<div style="position:fixed; right: 10px; top:20px; color:#eee;">背景颜色<br><select name=bcolor id=bcolor onchange="javascript:document.body.style.background=this.options[this.selectedIndex].value;"><option style="background-color: #ffffff" value="#ffffff">白色</option><option style="background-color: #f6f6f6" value="#f6f6f6">银灰</option><option style="background-color: #e4ebf1" value="#e4ebf1">淡蓝</option><option style="background-color: #e6f3ff" value="#e6f3ff">蓝色</option> <option style="background-color: #eeeeee" value="#eeeeee">淡灰</option><option style="background-color: #eaeaea" value="#eaeaea">灰色</option>  <option style="background-color: #e4e1d8" value="#e4e1d8">深灰</option><option style="background-color: #e6e6e6" value="#e6e6e6">暗灰</option><option style="background-color: #eefaee" value="#eefaee">绿色</option><option style="background-color: #ffffed" value="#ffffed">明黄</option><option style="background-color: #333333" value="#333333">黑色</option></select><br>字体颜色<br><select name=txtcolor id=txtcolor onchange="javascript:document.getElementById(\'container\').style.color=this.options[this.selectedIndex].value;"> <option value="#000000">黑色</option><option value="#ff0000">红色</option><option value="#006600">绿色</option><option value="#0000ff">蓝色</option><option value="#660000">棕色</option><option value="#ffffff">白色</option></select><br>字体大小<br><select name=fonttype id=fonttype onchange="javascript:document.getElementById(\'container\').style.fontSize=this.options[this.selectedIndex].value;"> <option value="12px" >小号</option> <option value="14px" >较小</option> <option value="19px" >中号</option> <option value="19px" >默认</option><option value="22px" >较大</option><option value="25px" >大号</option><option value="35px" >35px</option><option value="45px" >45px</option><option value="55px" >55px</option><option value="65px" >65px</option><option value="75px" >75px</option><option value="85px" >85px</option><option value="95px" >95px</option></select></div>');   
</script>
<style type="text/css">
#tbrowser a:link，#container a:visited{
	font-size:18px;
	text-decoration:none;
}
a:link{
	text-decoration:none;
	}
#container{
	font-size:1.2em;
	margin:auto;
	font-family:"宋体";
	width:40em;
	line-height:1.6em;
	//overflow:hidden;
}
P{
	margin-top:16px;
	margin-bottom:16px;
	text-indent:2em;
}
.uls{
	color:#CC6666;
	font-weight:bold;
}
.uls>ol{
	list-style:none;
	font-weight:normal;
	list-style:lower-latin;
	color:#000000;
	line-height:1.3em;
}
#goTopBtn, #goBottom, #shangy, #xiay, #menuPage, #lPage, #fPage, #ftsize1, #ftsize2, #ftsize3{
	width: 18px;
    line-height: 1.2;
    padding: 5px 0;
    font-size: 12px;
    text-align: center;
    position: fixed;
	right: 10px;
    cursor: pointer;
    filter: Alpha(opacity=30);
	opacity=.3;
	font-weight:bold;
}
#goTopBtn, #goBottom, #menuPage, #lPage, #fPage, #ftsize1, #ftsize3{
    background-color:#999;
    color:#000;
}
#shangy, #xiay, #lPage, #fPage, #ftsize, #ftsize2{
    background-color: #bbb;
    color: #000;
}
#fPage{
	bottom: 236px;
	height:42px;
	white-space:nowrap;
	overflow:hidden;
	//writing-mode:tb-rl;
}
#menuPage{
	bottom: 198px;
	height:27px;
	white-space:nowrap;
	overflow:hidden;
}
#lPage{
	bottom: 145px;
	height:42px;
	white-space:nowrap;
	overflow:hidden;
}
#ftsize1{
	bottom:360px;
}
#ftsize2{
	bottom:334px;
}
#ftsize3{
	bottom:308px;
}
#goTopBtn{
    bottom: 105px;
}
#goBottom {
    bottom: 30px;
}
#shangy {
    bottom: 80px;
}
#xiay {
    bottom: 55px;
}
#goTopBtn:hover, #goBottom:hover, #shangy:hover, #xiay:hover, #menuPage:hover, #lPage:hover, #fPage:hover, #ftsize1:hover, #ftsize2:hover, #ftsize3:hover{
	background-color:#ccc;
	border:#ccc 0px solid;
}
#goTopBtn a:link, #goBottom a:link, #xiay a:link, #shangy a:link, #menuPage a:link, #ftsize1 a:link, #ftsize2 a:link, #ftsize3 a:link, #menuPage a:visited, #lPage a:link, #fPage a:link, #lPage a:visited, #fPage a:visited {
	text-decoration: none;
	color:white;
}
img{
	margin-right:2em;
	text-indent:2em;
	border:0;
}
.picsay{
	color:#930;
	font-size:90%;
	line-height:110%;
	margin-top:-12px;
	padding:0;
}
.remark{
	color:#930;
	font-size:90%;
	line-height:140%;
	margin-top:-12px;
	text-indent:0em;
	padding:0;
}
.ref{
	color:#930;
	font-size:95%;
	line-height:150%;
	margin-top:-12px;
	text-indent:2em;
	padding:0;
}
.lettle{
	font-size:110%;
	line-height:160%;
	
	padding:0;
	color:#930;
	text-indent:2em;
}
sub,sup{
	font-size:80%;
	color:red;
}
.layout, .layout2{
    clear:both;
	width:95%;
	border:1px dotted #eee;
	margin:auto;
	margin-bottom:5px;
	overflow:hidden;
}
.layout2 .right, .layout2 .left, .layout p{
margin-bottom:-55px;
padding-bottom:55px;
text-align: justify;
margin:0;
padding:0;
margin-left:1%;
margin-right:1%;
}
.layout2 .left, .layout p{
float:left;
width:60%;
font-size:1.0em;
}
.layout2 .right,  .layout p+p {
	float: left;
	width:34%;
	border-left:1px dotted #cccccc;
	font-size:0.9em;
	padding-left:1%;
	
}
.layout2 .right p, .layout2 .left p, .layout p{
padding-bottom:5px;
}
h2{
	font-size:1.2em;
	font-weight:bold;
	margin-top:0px;
	margin-bottom:0px;
	text-indent:0em;
	color:#990000;
	height:1.5em;
}
h3{
	text-indent:0em;
	font-size:1.2em;
	height:1.5em;
	padding:0;
	margin:0;
	color:#990000;
}
h4{
	text-indent:0em;
	font-size:1em;
	height:1.5em;
	padding:0;
	margin:0;
	color:#990000;
}
.title
{
	text-indent:0em; font-weight:bold;
	font-size:120%;
}
pre{
	font-size:120%;
	line-height:130%;
	padding:0;
	//background-color:#f6f6f6;
	//background-color:#fff5ee;
	//background-color:#ffe;
	background-color:#eee;
	padding:8px;
	margin-left:2em;
	color:blue;
	}
</style>
</head>
<body>
<div id="container">
<h4>CE找包裹地址</h4>
﻿<p>早就答应给大家说一下我是怎么找包裹地址的，今天有空，我就简单的讲一下，希望对大家有帮助...</p>


<p>首先我们用CE来找出是什么指令修改了我们包裹中物品的数量（怎么找我就不说了，不懂的看CCB老大的教程）</p>


<p>找到指令是</p>


<p>0048F0AB   mov   dword ptr [ecx+14], edx</p>


<p>用OD打开武林elementclient.exe，Ctrl+G转到表达式0048F0AB...</p>


<p>可以看到这条指令是在一个函数中</p>



<pre>
0048F0A0 /$ 8B4424 04   mov   eax, dword ptr [esp+4]
0048F0A4 |. 8B51 14     mov   edx, dword ptr [ecx+14]
0048F0A7 |. 03D0       add   edx, eax
0048F0A9 |. 8BC2       mov   eax, edx
0048F0AB |. 8951 14     mov   dword ptr [ecx+14], edx
0048F0AE |. 85C0       test   eax, eax
0048F0B0 |. 7D 07       jge   short 0048F0B9
0048F0B2 |. C741 14 00000>mov   dword ptr [ecx+14], 0
0048F0B9 |> 8B41 18     mov   eax, dword ptr [ecx+18]
0048F0BC |. 8B51 14     mov   edx, dword ptr [ecx+14]
0048F0BF |. 3BD0       cmp   edx, eax
0048F0C1 |. 7E 03       jle   short 0048F0C6
0048F0C3 |. 8941 14     mov   dword ptr [ecx+14], eax
0048F0C6 |> 8B41 14     mov   eax, dword ptr [ecx+14]
0048F0C9 \. C2 0400     retn   4

</pre>

<p>我们在开始的地方F2下断，F8单步步过看看每条指令都做了些什么...</p>


<p>粗略的看一下，可以发现，当前CALL传入的参数1也就是[ESP+4]是-1，也就是我们使用了这个物品（比如吃药），[ECX+14]是存放的当前物品的数量，而[ECX+18]上存放的当前物品堆叠上限...因为是16进制的，所以大家要习惯看这些数值...</p>


<p>再看看程序流程，基本可以看出这个函数的功能是判断当前使用的物品是否超出1~99这个范围，也就是判断是否用完了或者是捡满了...</p>


<p>那么找包裹物品的地址，我们就要找出ECX的值是怎么来的！！！</p>


<p>OK，Ctrl+F9执行到返回，我们来看看是哪条指令调用了这个CALL...</p>


<p>返回到指令</p>


<p>0048908D |. E8 0E600000   call   0048F0A0</p>


<p>老习惯，我们上下拖动大致看看这段指令有多长...（其实主要是大概要回溯多长，因为我们要找ECX的值）</p>



<pre>
00489060 /$ 53         push   ebx
00489061 |. 8B5C24 08   mov   ebx, dword ptr [esp+8]
00489065 |. 56         push   esi
00489066 |. 57         push   edi
00489067 |. 85DB       test   ebx, ebx
00489069 |. 8BF9       mov   edi, ecx
0048906B |. 7C 3E       jl     short 004890AB
0048906D |. 3B5F 10     cmp   ebx, dword ptr [edi+10]
00489070 |. 7D 39       jge   short 004890AB
00489072 |. 8B47 0C     mov   eax, dword ptr [edi+C]
00489075 |. 8B3498     mov   esi, dword ptr [eax+ebx*4]
00489078 |. 85F6       test   esi, esi
0048907A |. 75 08       jnz   short 00489084
0048907C |. 5F         pop   edi
0048907D |. 5E         pop   esi
0048907E |. B0 01       mov   al, 1
00489080 |. 5B         pop   ebx
00489081 |. C2 0800     retn   8
00489084 |> 8B4C24 14   mov   ecx, dword ptr [esp+14]
00489088 |. F7D9       neg   ecx
0048908A |. 51         push   ecx
0048908B |. 8BCE       mov   ecx, esi
0048908D |. E8 0E600000   call   0048F0A0
</pre>

<p>先看看指令，发现ECX=ESI，往上ESI=[EAX+EBX*4]，OK！！！我们在</p>


<p>00489075 |. 8B3498     mov   esi, dword ptr [eax+ebx*4]</p>


<p>处下断...</p>


<p>发现EBX的值实际上就是我们点击包裹的格子序号（当然，人家是从0开始计数的...）</p>


<p>恩，有门...再就是找EAX的值是怎么来的了...</p>


<p>往上看，EAX=[EDI+C]，EDI=ECX...</p>


<p>没办法，ECX是由上一级函数传入的，好吧，继续Ctrl+F9...</p>


<p>转到指令</p>


<p>00457724 |. E8 37190300   call   00489060</p>


<p>还是上下看看...有点长，中间还有好几个CALL，郁闷...</p>


<pre>
004576B0 /$ 8B4424 04   mov   eax, dword ptr [esp+4]
004576B4 |. 53         push   ebx
004576B5 |. 55         push   ebp
004576B6 |. 56         push   esi
004576B7 |. 8B70 0C     mov   esi, dword ptr [eax+C]
004576BA |. 8BD9       mov   ebx, ecx
004576BC |. 33C9       xor   ecx, ecx
004576BE |. 57         push   edi
004576BF |. 8A0E       mov   cl, byte ptr [esi]
004576C1 |. 51         push   ecx
004576C2 |. 8BCB       mov   ecx, ebx
004576C4 |. E8 C7860000   call   0045FD90                 
004576C9 |. 8BE8       mov   ebp, eax
004576CB |. 85ED       test   ebp, ebp
004576CD |. 0F84 AC000000 je     0045777F
004576D3 |. 33D2       xor   edx, edx
004576D5 |. 6A 00       push   0
004576D7 |. 8A56 01     mov   dl, byte ptr [esi+1]
004576DA |. 8BCD       mov   ecx, ebp
004576DC |. 52         push   edx
004576DD |. E8 EE0F0300   call   004886D0
004576E2 |. 8BF8       mov   edi, eax
004576E4 |. 85FF       test   edi, edi
004576E6 |. 0F84 93000000 je     0045777F
004576EC |. 8B46 02     mov   eax, dword ptr [esi+2]
004576EF |. 8B4F 08     mov   ecx, dword ptr [edi+8]
004576F2 |. 3BC8       cmp   ecx, eax
004576F4 |. 0F85 85000000 jnz   0045777F
004576FA |. 6A 00       push   0                     ; /Arg3 = 00000000
004576FC |. 6A 00       push   0                     ; |Arg2 = 00000000
004576FE |. 50         push   eax                     ; |Arg1
004576FF |. 8BCB       mov   ecx, ebx                 ; |
00457701 |. E8 9A4A0200   call   0047C1A0                 ; \elementc.0047C1A0
00457706 |. 8B07       mov   eax, dword ptr [edi]
00457708 |. 8BCF       mov   ecx, edi
0045770A |. FF50 1C     call   dword ptr [eax+1C]
0045770D |. 66:8B46 06   mov   ax, word ptr [esi+6]
00457711 |. 66:85C0     test   ax, ax
00457714 |. 74 3C       je     short 00457752
00457716 |. 33C9       xor   ecx, ecx
00457718 |. 25 FFFF0000   and   eax, 0FFFF
0045771D |. 8A4E 01     mov   cl, byte ptr [esi+1]
00457720 |. 50         push   eax
00457721 |. 51         push   ecx
00457722 |. 8BCD       mov   ecx, ebp
00457724 |. E8 37190300   call   00489060
</pre>

<p>打起精神，记住我们要找的是ECX的值...</p>


<p>仔细看，就可以看出，ECX=EBP，而EBP=EAX</p>



<pre>
004576DA |. 8BCD       mov   ecx, ebp
004576C9 |. 8BE8       mov   ebp, eax
</pre>


<p>从函数开始下断，我们看看是什么指令修改了EAX的值...</p>


<p>恩，mov ebp, eax上面有个CALL，大家都应该知道对于高级语言，编译器一般习惯于将返回值放如EAX中的吧...</p>


<p>二话不说，先进call 0045FD90里面看看是个什么情况...</p>



<pre>
0045FD90 /$ 8B4424 04   mov   eax, dword ptr [esp+4]
0045FD94 |. 83F8 04     cmp   eax, 4                   ; Switch (cases 0..4)
0045FD97 |. 77 34       ja     short 0045FDCD
0045FD99 |. FF2485 D4FD45>jmp   dword ptr [eax*4+45FDD4]
0045FDA0 |> 8B81 3C080000 mov   eax, dword ptr [ecx+83C]       ; Case 0 of switch 0045FD94
0045FDA6 |. C2 0400     retn   4
0045FDA9 |> 8B81 40080000 mov   eax, dword ptr [ecx+840]       ; Case 1 of switch 0045FD94
0045FDAF |. C2 0400     retn   4
0045FDB2 |> 8B81 44080000 mov   eax, dword ptr [ecx+844]       ; Case 2 of switch 0045FD94
0045FDB8 |. C2 0400     retn   4
0045FDBB |> 8B81 78080000 mov   eax, dword ptr [ecx+878]       ; Case 3 of switch 0045FD94
0045FDC1 |. C2 0400     retn   4
0045FDC4 |> 8B81 7C080000 mov   eax, dword ptr [ecx+87C]       ; Case 4 of switch 0045FD94
0045FDCA |. C2 0400     retn   4
0045FDCD |> 33C0       xor   eax, eax                 ; Default case of switch 0045FD94
0045FDCF \. C2 0400     retn   4
0045FDD2     8BFF       mov   edi, edi
0045FDD4   . A0FD4500     dd     elementc.0045FDA0           ; 分支表 被用于 0045FD99
0045FDD8   . A9FD4500     dd     elementc.0045FDA9
0045FDDC   . B2FD4500     dd     elementc.0045FDB2
0045FDE0   . BBFD4500     dd     elementc.0045FDBB
0045FDE4   . C4FD4500     dd     elementc.0045FDC4
</pre>

<p>发现是个分支处理的函数，至于吃药是怎么分支的，我们先出去看看这个参数[ESP+4]和ECX的值是怎么来的...</p>


<pre>
004576BF |. 8A0E       mov   cl, byte ptr [esi]
004576C1 |. 51         push   ecx
004576C2 |. 8BCB       mov   ecx, ebx
004576C4 |. E8 C7860000   call   0045FD90
</pre>


<p>下断，可以知道push ecx的时候ECX是0，而mov ecx,ebx的时候不知道大家看出来什么没有...</p>


<p>当时我就觉得这个EBX的值很熟，后来一想，这个值不就是人物属性地址[[8BCB44]+1C]+24的值么...</p>


<p>而且，吃药的时候，那个CALL要传入的参数始终是0...</p>


<p>至此，所有的我们需要的信息都找到了...</p>


<p>那我们就可以总结了...</p>


<pre>
[[[[8BCB44]+1C]+24]+83C]+10 的值是角色包裹最大容量...
[[[[8BCB44]+1C]+24]+83C]+C 是角色包裹首地址...
[[[[[8BCB44]+1C]+24]+83C]+C]+4*格子序号 是格子物品首地址...
[[[[[[8BCB44]+1C]+24]+83C]+C]+4*格子序号]+14 是此格物品的数量...
[[[[[[8BCB44]+1C]+24]+83C]+C]+4*格子序号]+18 是此格物品的堆叠上限...
</pre>


<p>授人以鱼，不如授人以渔...关于其他的地址需要大家举一反三，自己查找了，我在这只是起个抛砖引玉的作用...</p>


<p>呵呵，写完了，不知道写得明不明白，有什么问题希望大家多多批评，谢谢！</p>
﻿
</div>
<div>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.4em";' target="_self" style="color:#fff;" title="大：1.4em"><div id="ftsize1" style="color:#fff;">大</div></a>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.2em";' target="_self" style="color:#fff;" title="中：1.2em"><div id="ftsize2" style="color:#fff;">中</div></a>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.0em";' target="_self" style="color:#fff;" title="小：1em"><div id="ftsize3" style="color:#fff;">小</div></a>
<a id="fPagea" href="index.html" target="_self"><div id="fPage" style="color:#fff;">上<br>一<br>章</div></a>
<a href="index.html" target="_self"><div id="menuPage" style="color:#fff;">目<br>录</div></a>
<a id="LPagea" href="javascript:void(null)" target="_self"><div id="lPage" style="color:#fff;">下<br>一<br>章</div></a>
<a target="_self" style="color:#fff;"><div style="display:none; color:#fff;" id="goTopBtn">&and;</div></a>
<a onclick="shangy()" target="_self" style="color:#fff;"><div style="display:none; color:#fff;" id="shangy">&uarr;</div></a>
<a onclick="xiay()" target="_self" style="color:#fff;"><div id="xiay" style="color:#fff;">&darr;</div></a>
<a onclick="downn()" target="_self" style="color:#fff;"><div id="goBottom" style="color:#fff;">&or;</div></a>
<script type=text/javascript>
	goTopEx();
	function xiay(){
		window.scrollBy(0,window.innerHeight-10);
	}
	function shangy(){
		window.scrollBy(0,-window.innerHeight+10);
	}
	var obj3=document.getElementById("xiay");
	var obj4=document.getElementById("goBottom");
	function getHeight(){  
		if(browser4=="ch"){
			//谷歌浏览器  
			return document.body.clientHeight; 
		}else{
			//IE、firefox等浏览器 
			return document.documentElement.clientHeight;  
		}  
	}
	getHeight()<window.innerHeight+50?obj3.style.display="none":obj3.style.display="";
	getHeight()<window.innerHeight+50?obj4.style.display="none":obj4.style.display="";
	if(browser4!="ch"){	//firefox需要尝一下才显示向下图标
		xiay();
		shangy();
	}
	//上一页、下一页按钮，需要文件名是数字
	var strUrl=window.location.href;
	var arrUrl=strUrl.split("/");
	var thispage=arrUrl[arrUrl.length-1];
	var thispage2=thispage.split(".");
	var thispage3=thispage2[thispage2.length-2];
	if(thispage3 == 0){
		var obj5=document.getElementById("fPage");
		obj5.style.display="none";
	}else{
		var fpage = thispage3 - 1;
		fpage = fpage +".html";
		document.getElementById("fPagea").href=fpage;
	}
	if(thispage3 == 31){
		var obj6=document.getElementById("lPage");
		obj6.style.display="none";
	}else{
		var fpage = parseInt(thispage3) + 1;
		fpage = fpage +".html";
		document.getElementById("LPagea").href=fpage;
	}
</script>
</div>
</body>
</html>
