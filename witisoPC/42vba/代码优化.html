<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>代码优化</title> <meta http-equiv="content-type" content="text/html; charset=utf-8">
</meta></head>

<style type="text/css">
#tbrowser a:link，.container a:visited{
font-size:18px;
text-decoration:none;
}
.container{
font-size:1.2em;
margin:auto;
font-family:"宋体";
width:75.29%;
line-height:1.4em;
}
P{
margin:8px;
text-indent:2em;
line-height:32px;
}
.uls{
color:#CC6666;
font-weight:bold;
}
.uls>ol{
list-style:none;
font-weight:normal;
list-style:lower-latin;
color:#000000;
line-height:1.3em;

}
h2{
font-size:20px;
font-weight:bold;
margin-top:15px;
margin-bottom:0px;
text-indent:0em;
}
img{
margin-right:5px;
}
.fc{
color:red;
}

a:link {
	text-decoration: none;
}


a:visited {
	text-decoration: none;
}
a:hover {
	text-decoration: none;
}
a:active {
	text-decoration: none;
}


#goTopBtn {
	width: 18px;
  line-height: 1.2;
  padding: 5px 0;
  background-color:#eee;
  color:#000;
  font-size: 12px;
  text-align: center;
  position: fixed;
  _position: absolute;
 
  right: 10px;
  bottom: 100px;
  _bottom: "auto";
  cursor: pointer;
  opacity: .6;
  filter: Alpha(opacity=30);
	opacity=.3;
}
 #goTopBtn:hover{
 background-color:white;
 border:#ccc 1px solid;
 color:red;
 }
 
 
#goBottom {
	width: 18px;
  line-height: 1.2;
  padding: 5px 0;
  background-color: #eee;
  color: #fff;
  font-size: 12px;
  text-align: center;
  position: fixed;
  _position: absolute;
 
  right: 10px;
  bottom: 70px;
  _bottom: "auto";
  cursor: pointer;
  filter: Alpha(opacity=30);
	opacity=.3;
}
 #goBottom:hover{
 background-color:white;
 border:#ccc 1px solid;
 color:red;
 }
 
 
 img{
 border:0;
 }#tbrowser {
	width:100%;
	margin:auto;
	border-collapse:collapse;
font-family:"宋体";
	text-align:left;
	line-height:1.3em;
	table-layout:fixed;
}

#tbrowser th,#tbrowser td{
border:1px solid #ddd;
font-size:1em;
color:#000000;
text-align:left;
font-family: "宋体";
padding-left:3px;
}


#tbrowser thead th{
border-bottom:2px solid #3d580b;
background-color:#8fc629;
color:#fff;
padding:5px 0px;
}
#tbrowser .nd{
border-bottom:2px solid #3d580b;
background-color:#8fc629;
background-color:#D3D3A9;
color:red;
}

#tbrowser th{
border-bottom:2px solid #3d580b;
background-color:#8fc629;
color:#fff;
padding:5px 0px;
}
#tbrowser th.title{
background-color:#e3e685;
}

#tbrowser caption{
font-weight:bold;
padding:1px 0px;
color:#3d580b;
font-size:18px;
}


#tbrowser .xhx{
border-bottom:0px solid #aaa;
}


#tbrowser tr{
height:6px;
}

#tbrowser tr>td{/*1*/
font-size:1em;
text-align:left;
/*width:13%;*/
}
#tbrowser tr>td+td{/*2*/
text-align:left;
/*width:8%;*/
font-size:1em;
}
#tbrowser tr>td+td+td{/*3*/
font-size:1em;
/*width:5%;*/
}
#tbrowser tr>td+td+td+td{/*4*/
font-size:1em;
text-align:left;
/*width:6%;*/
}
#tbrowser tr>td+td+td+td+td{/*5*/
font-size:1em;
text-align:left;
/*width:5%;*/
}
#tbrowser tr>td+td+td+td+td+td{/*6*/
/*width:13%;*/
font-size:1em;
}
#tbrowser tr>td+td+td+td+td+td+td{/*7*/
/*width:59%;*/
font-size:1em;
}


#tbrowser tfoot td{
border-width:0px;
text-align:left;
line-height:18px;
font-size:16px;
color:#777;
}
.floatr{
float:right;
padding-right:5px;
}

#tbrowser th a:link {
	text-decoration: none;
	color:white;
}
#tbrowser th a:hover {
	text-decoration: none;
	color:white;
}
#tbrowser th a:active {
	text-decoration: none;
	color:white;
}
#tbrowser th a:visited {
	text-decoration: none;
	color:white;
}
#tbrowser caption{
font-size:1.2em;
text-align:left;
}
#tbrowser thead td{
font-size:0.8em;
text-align:left;
}div{
margin:auto;
width:74%;
border:0px blue solid;
}
p{
margin:0px;
text-indent:2em;
line-height:28px;
margin-top:8px;}
.data{
border:1px blue solid;

clear:both;
height:150px;
padding:2px;
margin-top:12px;

}
#tbrow{
border-collapse:collapse;
margin:auto;
width:88%;
}
#tbrow td{
border:0px solid blue;
}
.li{
list-style-type:decimal;
}
</style>


<body>

<div class="container">


<p>优化代码</p>
<p>1 强制声明变量</p>
<p>VBA并不要求用户必须声明每个变量，VBA会自动为每个变量分配数据类型。 这是相对于其它程序软件的一个优点，即兼容性好。然而同时也是一个缺点，不声明变量其类型时程序在执行时将会消耗更多的内存。相当于牺牲效率换取兼容性。</p>
<p>为了提升程序的效率，在编写代码时，应尽量将所有变量显示声明，除非某个变量的类型无法把握（初学者较常见）。</p>
<p>2 善用常量</p>
<p>如果某个数值或者字符串在程序中反复出现，那么尽量声明一个常量做取代该</p>
<p>值，将后在代码中直接调用常量。</p>
<p>3 关闭屏幕更新</p>
<p>在单元格中写入数据或者批量插入图形对象时，每执行一句代码屏幕会更新一次，而更新屏幕需要时间。在大多数情况下，完全没有必要更新屏幕的状态。开发者可以关闭屏幕更新来提升效率，等所有过程执行完毕后再恢复屏幕更新即可。</p>
<p>VBA提供了一个可以控制屏幕更新开、关的属性：ScreenUpdating。它的语法如下：</p>
<p>Application.ScreenUpdating=True/False</p>
<p>如果将该属性值设为True则允许屏幕更新，否则禁止屏幕更新。</p>
<p>4 利用WITH减少对象读取次数</p>
<p>利用WITH减少对象读取次数</p>
<p>VBA中读取对象需要花费一定的时间，而且对于多级对象（同时列出父对象与子对象）时需要的时间更长。例如以下两句代码：</p>
<p>[a1]</p>
<p>ThisWorkbook.Sheets(1).[a1]</p>
<p>虽然它们都指向同一个单元格对象，对A1读写后的结果也完全一致，然而前者圆点更少，读取时间也相应更少。在VBA中引用对象时，每出现一个圆点就需要去读取一个对象。</p>
<p>5 利用变量减少对象读取次数</p>
<p>如果某个变量在一个过程中多次出现，应考虑用一个变量来替换该对象。因为变量存在内存中，VBA读取内存数据远远快于对象。</p>
<p>6 善用带$的字符串处理函数</p>
<p>在VBA中，有两套字符串处理函数，包括带“$”和不带“$”的函数，例如Mid和Mid$，Left和Left$，Right和Right$。</p>
<p>如果使用不带“$”符号的函数计算字符串，那么VBA将字符串作为变体型数据进行计算，而使用带“$”的函数时则将字符串当做String类型进行计算。显示变体型数据在计算时需要更多的内存空间。</p>
<p>例如以下两句代码，第二句在执行效率上会稍占优势： Reault = Mid(&quot;中华人民共和国&quot;, 3) Reault = Mid$(&quot;中华人民共和国&quot;, 3)</p>
<p>7 善用循环中的步长减少循环次数</p>
<p>当使用有针对性的For循环，即仅仅需要对循环对象中的部分对象进行操作时，应该调整循环的步长来减少循环的次数。</p>
<p>例如将奇数行添加背景色，步长为1的For循环代码如下：</p>
<p>Sub 前10000行背景着色()   tim = Timer </p>
<p>For i = 1 To 100000</p>
<p>    
 IF i Mod 2 = 1 Then Cells(i, 1).EntireRow.Interior.ColorIndex = 15   Next i </p>
<p>MsgBox Format(Timer - tim, &quot;0.00&quot;) &amp; 秒 End Sub</p>
<p>本代码需要循环的次数是10000次</p>
<p>Sub 前10000行背景着色2()   tim = Timer </p>
<p>For i = 1 To 100000 Step 2</p>
<p>     
 Cells(i, 1).EntireRow.Interior.ColorIndex = 15   Next i </p>
<p>MsgBox Format(Timer - tim, &quot;0.00&quot;) &amp; 秒 End Sub</p>
<p>本代码需要循环的次数是5000次，其执行结果与前一个过程完全一致。读者可以分别执行两个过程测试其时间。</p>
<p>8 利用数组代替单元格对象</p>
<p>VBA处理数组的速度远远大于处理对象的速度，对于可以利用数组来替换对象的都尽量使用数据，例如1000个图片的名称，或者1000个单元格，或者不确定个数的工作表名称。 </p>
<p>&nbsp;</p>
<p>9 不重复调用自定义函数时不使用自定义函数</p>
<p>在VBA中，对于一些较短小的自定义函数，调用函数往往比函数过程的执行时间都长。对于简单的运算尽量不使用自定义函数，而是直接将函数的过程写在Sub过程中。</p>
<p>10 将不改变值或者属性的语句放到循环语句外</p>
<p>循环语句都需要反复运行，如果错误将不需要循环执行的语法置于循环体中将会消耗额外的内存，占用不必要的时间。</p>
<p>11 将不改变值或者属性的语句放到循环语句外</p>
<p>循环语句都需要反复运行，如果错误将不需要循环执行的语法置于循环体中将会消耗额外的内存，占用不必要的时间。</p>
<p>12 尽量调用内置功能 </p>
<p>有很多操作，可以编写VBA代码计算来实现，也可以调用Excel的内置的功能实现。开发者应尽量借用内置功能实现，除了速度快之外，调用内置功能的代码也简单许多。</p>
<p>例如对一列数据排，虽然可以对数据逐个进行大小比较，然后再按大小顺序排列来完成需求，但在写法上以及效率上较一句代码调用内置排序功能Sort会差一些。</p>
<p>13 利用对象循环替代单元格循环</p>
<p>如果对当前表中与单元格关联的对象进入某项操作时，如果循环单元格方式可以完成，循环其它对象也可以完成，那么尽量对其它对象进行循环，从而减少循环次数。</p>
<p>&nbsp;</p>
</div>
</body>
</html>
